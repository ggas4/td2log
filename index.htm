<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div id="pre-form">
        <h1>Witamy w narzędziu śledzenia pociągów w Train Driver 2!</h1>
        <label for="num">Wybierz numer pociągu z listy:</label>
        <br />
        <br />
        <select id="num" name="trainSelector">
            <option value="n/a">Wybierz pociąg</option>
        </select>&nbsp;
        <button id="track">Śledź</button>
    </div>
    <div id="tracking" hidden="hidden">

    </div>
    <button id="save" hidden="hidden">Zapisz</button>
    <button id="stop" hidden="hidden">Stop!</button>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="FileSaver.js"></script>
    <script>
        let loaded = false;
        let interval = null;

        var lastT = {
            signal: null,
            timetable: null
        };

        function retrieveHours(hr) {
            if (hr.hrs < 10) {
                hr.hrs = '0' + hr.hrs;
            }
            if (hr.mins < 10) {
                hr.mins = '0' + hr.mins;
            }
            return hr;
        }

        $('#num').click(function () {
            if (!loaded) {
                var API = $.getJSON('https://api.td2.info.pl:9640/?method=getTrainsOnline').done(function () {
                    var resp = [];
                    API = API.responseJSON.message;
                    var trainCounter = (API.length) - 1;
                    for (var sel = 0; sel <= trainCounter; sel++) {
                        resp.push(API[sel].trainNo);
                    }
                    $('#num').html('');
                    for (var i = 0; i < resp.length; i++) {
                        $('#num').append('<option value="' + resp[i] + '">' + resp[i] + '</option>');
                    }
                });
                loaded = true;
            }
        });

        function trace() {
            var num = $('#num').val();
            var API = $.getJSON('https://api.td2.info.pl:9640/?method=getTrainsOnline').done(function () {
                API = API.responseJSON.message;
                var trainCounter = (API.length) - 1;
                var sel;
                var currentHour = {
                    hrs: new Date().getHours(),
                    mins: new Date().getMinutes()
                }
                currentHour = retrieveHours(currentHour);
                for (sel = 0; sel <= trainCounter; sel++) {
                    if (API[sel].trainNo == num) {
                        if (lastT.signal != API[sel].dataSignal) {
                            var html = $('#tracking').html();
                            html += '<p class="record">Godzina ' + (currentHour.hrs) + ':' + (currentHour.mins) + ', Sceneria ' + API[sel].station.stationName + ', Semafor ' + API[sel].dataSignal + '</p>';
                            $('#tracking').html(html);
                            lastT.signal = API[sel].dataSignal;
                        }
                        return;
                    }
                }
            });
        }

        $('#track').click(function () {
            $('#pre-form').hide();
            $('#save').show();
            $('#stop').show();

            req = $.getJSON('https://api.td2.info.pl:9640/?method=readFromSWDR&value=getTimetable;' + $('#num').val() + ';eu').done(function () {
                try {
                    $('#tracking').html('<p class="notice1">Rozpoczynam śledzenie pociągu ' + req.responseJSON.message.trainInfo.trainCategoryCode + ' ' + $('#num').val() + ', informacje odświeżane co pół minuty...</p>');
                }
                catch{
                    $('#tracking').html('<p class="notice1">Rozpoczynam śledzenie pociągu ' + $('#num').val() + ', informacje odświeżane co pół minuty...</p>');

                }
                finally {
                    trace();
                    $('#tracking').show();
                    interval = setInterval('trace()', 5000);
                }
            });
        });

        $('#stop').click(function () {
            location.reload(true);
        });

        $('#save').click(function () {
            saveAs(new Blob([$('#tracking').html().replace('<br>', '\n')]), "log.html");
        });

    </script>
</body>

</html>